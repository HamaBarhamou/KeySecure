version: '3.8'

services:
  mariadb:
    image: mariadb:10.11.4
    container_name: mariadb
    ports:
      - "3307:3306"
    environment:
      - MARIADB_DATABASE=keycloak
      - MARIADB_USER=keycloak
      - MARIADB_PASSWORD=password
      - MARIADB_ROOT_PASSWORD=root_password

  keycloak-clustered-1:
    image: ivanfranchin/keycloak-clustered:latest
    container_name: keycloak-clustered-1
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=mariadb
      - KC_DB_URL_HOST=mariadb
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=password
      - KC_LOG_LEVEL=INFO,org.infinispan:DEBUG,org.jgroups:DEBUG
      - JGROUPS_DISCOVERY_EXTERNAL_IP=keycloak-clustered-1
    ports:
      - "8080:8080"
    command: start-dev
    depends_on:
      - mariadb

  keycloak-clustered-2:
    image: ivanfranchin/keycloak-clustered:latest
    container_name: keycloak-clustered-2
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=mariadb
      - KC_DB_URL_HOST=mariadb
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=password
      - KC_LOG_LEVEL=INFO,org.infinispan:DEBUG,org.jgroups:DEBUG
      - JGROUPS_DISCOVERY_EXTERNAL_IP=keycloak-clustered-2
    ports:
      - "8081:8080"
    command: start-dev
    depends_on:
      - mariadb

  keycloak-clustered-3:
    image: ivanfranchin/keycloak-clustered:latest
    container_name: keycloak-clustered-3
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=mariadb
      - KC_DB_URL_HOST=mariadb
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=password
      - KC_LOG_LEVEL=INFO,org.infinispan:DEBUG,org.jgroups:DEBUG
      - JGROUPS_DISCOVERY_EXTERNAL_IP=keycloak-clustered-3
    ports:
      - "8082:8080"
    command: start-dev
    depends_on:
      - mariadb

  keycloak-clustered-4:
    image: ivanfranchin/keycloak-clustered:latest
    container_name: keycloak-clustered-4
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
      - KC_DB=mariadb
      - KC_DB_URL_HOST=mariadb
      - KC_DB_URL_DATABASE=keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=password
      - KC_LOG_LEVEL=INFO,org.infinispan:DEBUG,org.jgroups:DEBUG
      - JGROUPS_DISCOVERY_EXTERNAL_IP=keycloak-clustered-4
    ports:
      - "8083:8080"
    command: start-dev
    depends_on:
      - mariadb
